\فصل{جمع‌آوری داده‌گان}

مدل را دوبار به وسیله ی دو مجموعه داده‌ی متفاوت آموزش دادیم.

\قسمت{داده‌گان \متن‌لاتین{PeMSD7}}
این دیتاست توسط دوربین‌های سرعت‌سنجی که در نقاط مختلف قرار می‌گیرند جمع آوری شده‌اند. محل استقرار این دوربین‌ها ثابت است و کار ما در ساختن ماتریس فاصله بسیار ساده می کند همچنین سرعتی که این دوربین‌ها گزارش می‌دهند بسیار قابل اعتماد است و دیتاستی که با آن کار کردیم نیز داده‌ی پرت و یا گمشده‌ی کمی داشت. این مجموعه داده توسط اداره‌ی حمل و نقل ایالت کالیفرنیا\پانویس{https://pems.dot.ca.gov/} جمع آوری شده است.
این داده مربوط به ۲۲۸ ایستگاه است که به صورت تصادفی از میان ۳۹ هزار ایستگاه‌ انتخاب شده‌اند و شامل ۱۲ هزار سطر است که نشان دهنده‌ی سرعت ترافیک در این ۲۲۸ ایستگاه با توالی زمانی پنج دقیقه است.
داده‌ها در ماه‌های می تا جون سال ۲۰۱۲ جمع آوری شده‌اند و جهت پاک کردن داده‌های ترافیکی بی‌قاعده روزهای غیرکاری حذف شده‌اند.
مجموعه داده‌ی \متن‌لاتین{PeMSD7} به صورت متن باز در تارنمای \تارنما{https://github.com/VeritasYin/STGCN_IJCAI-18} منتشر شده است.

\قسمت{داده‌گان \متن‌لاتین{Snapp}}

این مجموعه داده توسط سیستم موقعیت‌‌یاب‌جهانی رانندگان جمع‌آوری شده‌است در نتیجه نمی‌توان سرعت ترافیک یک نقطه را پیدا کرد بلکه می‌توان
به طور مثال سرعت ترافیک در یک خیابان را دانست این موضوع ساختن ماتریس فاصله را مشکل می‌کند همچنین داده‌های آن به دلایل متعدی مانند
وجود ساختمان‌های بلند قابل اعتماد نیست. از طرفی این داده در ابتدا سرعت ترافیک در یک خیابان نیست بلکه سیگنال‌های \متن‌لاتین{GPS} رانندگان است. برای آماده کردن داده مراحل زیر انجام شده است.

\شروع{شمارش}

\فقره نوشتن \متن‌لاتین{cron job} برای گرفتن داده‌گان: به علت حجم بالای داده‌گان گرفتن تمام داده‌گان به صورت پشت‌سر‌هم مقدور نبود
در نتیجه \متن‌لاتین{cron job} نوشته شد تا در هر دقیقه تلاش کند و یک میزان\پانویس{bulk} از داده‌گان را بگیرد.

\فقره نگاشت نقطه بر نقشه\پانویس{map matching}: سیگنال \متن‌لاتین{GPS} رانندگان به صورت دقیق بر روی خیابان نمی‌افتد و ابتدا باید خیابان مربوط به هر سیگنال \متن‌لاتین{‌GPS} را پیدا کنیم.

\فقره محاسبه‌ی سرعت بر اساس سیگنال‌های \متن‌لاتین{GPS}: یکی از اطلاعاتی که سیگنال \متن‌لاتین{GPS} در اختیار ما قرار می‌دهد سرعت است اما این سرعت به صورت لحظه‌ای است و دارای خطای بسیار زیادی است به همین دلیل خود به محاسبه‌ی سرعت می‌پردازیم. پس از مرحله‌ی قبل که رشته‌ی \متن‌لاتین{GPS}های پشت‌سر‌هم به دست آمدند از تقسیم فاصله‌ی کروی دو سیگنال پشت‌سر‌هم بر اختلاف زمانی رخ دادن آن‌ها سرعت محاسبه می‌شود.


\فقره تمیز کردن مجموعه داده: مجموعه داده‌ی \متن‌لاتین{GPS} رانندگان دارای صفر و داده‌های پرت بسیاری است و نیاز دارد تا به دقت پیش‌پردازش شود. به طور مثال باید بررسی شود که داده‌ی راننده‌هایی که در حال سفر نیستند حذف شود.

\فقره حذف داده‌ی غیرقابل اعتماد: هدف در این پروژه ارایه‌ی مدلی بود که بتواند به خوبی سرعت ترافیک را پیش‌بینی کند مساله‌ی مسیریابی در حوزه‌ی کاری این پروژه نمی‌گنجد اما ذکر این موضوع خالی از لطف نیست که حتی اگر مدل ما توانایی بالایی در یادگیری داده‌ای که به آن می‌ٔدهیم و پیش‌بینی سرعت ترافیک داشته باشد خطا در گام‌های اولیه مانند محاسبه‌ی سرعت باعث می‌شود مجموعه داده‌ای که مدل قرار است به وسیله‌ی آن آموزش ببیند دارای نویز زیادی باشد و هدف ایده‌آل ما که مسیریابی است کاملا تحت‌الشعاع قرار می‌گیرد به همین دلیل در مکان‌هایی که داده‌ی قابل اعتمادی نداریم به طور مثال وقتی تعداد کل سیگنال‌های متن‌لاتین{GPS} که در یک خیابان مشخص در اختیار داریم از آستانه‌ی مشخصی پایین‌تر باشد سرعت آن خیابان را برابر جریان عمومی\پانویس{general flow} قرار می‌دهیم

\فقره رانندگان از بسیاری از خیابان‌ها مانند کوچه‌های محلی \پانویس{residential} عبور نمی‌کنند در نتیجه نمی‌توان سرعتی برای آن خیابان‌ها حساب کرد. در این پروژه ما \متن‌لاتین{SharedStreet}‌هایی را مورد مطالعه قرار دادیم که این اتفاق برایشان نمی‌افتد.

\فقره برای نگاشت \متن‌لاتین{GPS} ها بر نقشه از پروژه‌ی متن باز \متن‌لاتین{https://github.com/bmwcarit/barefoot} که توسط شرکت \متن‌لاتین{BMW} توسعه داده شده است استفاده کرده‌ایم.

\پایان{شمارش}

\زیرقسمت{نگاشت نقطه بر نقشه}
در بالا صحبت شد که \متن‌لاتین{GPS} ها باید بر نقشه نگاشت شوند درباره‌ی چگونگی تولید این نقشه در ادامه بیشتر صحبت می‌کنیم:

\زیرزیرقسمت{سیستم مرجع \متن‌لاتین{SharedStreet}}
استانداردهای داده‌ی \متن‌لاتین{SharedStreet} روشی است که بتوان به صورت منحصر به فرد خیابان‌ها را شناسایی کرد و داده‌گان مرتبط با آن خیابان را به آن متصل کرد. \متن‌لاتین{SharedStreet} این امکان را فراهم می‌آورد که نقشه‌های مختلف بتوانند با هم تعامل کنند و اجازه‌ی انتقال اطلاعات بین ارائه‌های مختلف خیابان‌ها را می‌دهد مانند داده‌گان مربوط به \متن‌لاتین{OpenStreetMap}، یک سیستم اطلاعات جغرافیایی\پانویس{Geographic Information System (GIS)} مدیریت شهری، نقشه‌های پایه‌ی تجاری\پانویس{commercial basemap}.

امروزه شهرها برای جمع‌آوری و اشتراک داده‌ها وابسته به سیستم اطلاعات جغرافیایی هستند اما این امر نیازمند این است که کاربران بر روی یک نقشه و یا استفاده از شناسه‌های از پیش تعریف شده و اغلب اختصاصی برای تعیین خیابان‌ها توافق کنند.

این امر پتانسیل همکاری و به اشتراک گذاری داده ها را بین سازمان های دولتی و بخش خصوصی را محدود می کند. و استفاده از نقشه های اختصاصی و سیستم های شناسایی می تواند توانایی شهرها را برای استفاده و به اشتراک گذاری اطلاعات عمومی مهم در مورد خیابان ها تضعیف کند.

\متن‌لاتین{SharedStreet} یک سیستم جهانی و غیر اختصاصی برای توصیف خیابان‌ها فراهم می‌کند که برای ترکیب هر منبع داده‌ای مرتبط با خیابان طراحی شده است. این به نهادهای دولتی و خصوصی اجازه می دهد تا با وضوح و دقت در مورد خیابان ها ارتباط برقرار کنند و در عین حال از سازگاری کامل با داده های نقشه داخلی سازمان ها اطمینان حاصل کنند.


\شروع{شکل}
  \درج‌تصویر[height=8cm]{./images/gis_vs_sharedstreets.png}
  \تنظیم‌ازوسط
  \شرح{سیستم \متن‌لاتین{SharedStreet} در برابر سیستم اطلاعات جغرافیایی}
  \برچسب{fig:time-conv}
 \پایان{شکل}

 سیستم مرجع \متن‌لاتین{SharedStreet} بر روی چهار لایه از داده ساخته شده است

\شروع{شمارش}

\فقره ارجاعات \متن‌لاتین{SharedStreet}: ارجاعات مستقل از نقشه‌ی پایه برای بخش‌هایی از خیابان که میان دو تقاطع قرار دارند.


\شروع{شکل}
  \درج‌تصویر[height=8cm]{./images/sharedstreets_references.png}
  \تنظیم‌ازوسط
  \شرح{ ارجاعات \متن‌لاتین{SharedStreet}}
  \برچسب{fig:time-conv}
\پایان{شکل}


\فقره تقاطع \متن‌لاتین{SharedStreet}: گره هایی که ارجاعات بخش های خیابان را به هم متصل می کنند.


\شروع{شکل}
  \درج‌تصویر[height=8cm]{./images/sharedstreets_intersections.png}
  \تنظیم‌ازوسط
  \شرح{ تقاطع \متن‌لاتین{SharedStreet}}
  \برچسب{fig:time-conv}
\پایان{شکل}


\فقره هندسه‌های \متن‌لاتین{SharedStreet}: هندسه های مورد استفاده برای تولید ارجاعات بخش خیابان
\شروع{شکل}
  \درج‌تصویر[height=8cm]{./images/sharedstreets_geometries.png}
  \تنظیم‌ازوسط
  \شرح{هندسه‌های \متن‌لاتین{SharedStreet}}
  \برچسب{fig:time-conv}
\پایان{شکل}


\فقره فراداده \متن‌لاتین{OSM}: راه‌های \متن‌لاتین{OSM} و ارجاعات گره مورد استفاده برای ساخت داده های \متن‌لاتین{SharedStreet}

\پایان{شمارش}


به مجموعه‌ی \متن‌لاتین{SharedStreet}ها که شامل چهار نوع فایل توضیح داده شده در بالا است \متن‌لاتین{tile} گفته می‌شود. برای نگاشت نقطه بر نقشه به این \متن‌لاتین{tile} احتیاج داریم. ساختن این \متن‌لاتین{tile} مدت زمان زیادی نیاز دارد به طور مثال برای ساختن \متن‌لاتین{tile} شهر تهران که منطقه‌ی مورد مطالعه‌ی ما است حدود دو ساعت زمان صرف شد.

\زیرزیرقسمت{نگاشت \متن‌لاتین{GPS} بر \متن‌لاتین{tile}}


\شروع{شکل}
  \درج‌تصویر[height=8cm]{./images/mapMatch.png}
  \تنظیم‌ازوسط
  \شرح{نگاشت نقطه بر نقشه}
  \برچسب{fig:time-conv}
\پایان{شکل}

هر سیگنال \متن‌لاتین{GPS} متعلق به یک خیابان است که خیابان مورد نظر برای ما پنهان است و ما تنها سیگنال را می‌توانیم مشاهده کنیم
از طرفی ما رشته‌ی این سیگنال‌های \متن‌لاتین{GPS} را داریم، در نتیجه می‌توانیم از الگوریتم مدل پنهان مارکوف\پانویس{hidden markov model} \مرجع{Rabiner1986} استفاده کنیم.
برای هر سیگنال می توان $k$ خیابان نزدیک به آن را به عنوان حالت‌های پنهان احتمالی فرض کرد و سپس احتمالات انتشار و انتقال را به‌دست‌آورد.

\شروع{شکل}
  \درج‌تصویر[height=8cm]{./images/hmm.png}
  \تنظیم‌ازوسط
  \شرح{مدل پنهان مارکوف}
  \برچسب{fig:time-conv}
\پایان{شکل}

حال با استفاده از الگوریتم ویتربی\پانویس{viterbi} می توانیم محتمل‌ترین رشته و در نتیجه محتمل‌ترین نگاشت را پیدا کنیم.
پس از اتمام عملیات نگاشت می‌توانیم سرعت حرکت راننده، جهت حرکت او و شماره‌ی مرجع خیابان \پانویس{Road Segment ID} را پیدا کنیم.

\زیرزیرقسمت{محاسبه‌ی سرعت برای هر راننده}
نحوه‌ی محاسبه‌ی سرعت یک راننده در یک خیابان در شکل؟؟؟؟؟؟؟؟؟؟؟؟؟؟؟؟؟؟؟؟؟؟ نشان داده شده است. فرض کنید یک راننده در حال عبور از یک خیابان است و سه \متن‌لاتین{‌GPS} در آن خیابان می‌اندازد از \متن‌لاتین{GPS} اول و دوم یک سرعت و از \متن‌لاتین{‌GPS} دوم و سوم سرعتی دیگر محاسبه می‌شود. حال اگر \متن‌لاتین{GPS} اول و دوم یک دهم خیابان و \متن‌لاتین{GPS} دوم و سوم چهار دهم خیابان را در بر بگیرند. برای محاسبه‌ی سرعت کلی راننده در خیابان سرعت دوم، چهار برابر سرعت اول موثر است.

\شروع{شکل}
  \درج‌تصویر[height=8cm]{./images/speed_per_driver.drawio.png}
  \تنظیم‌ازوسط
  \شرح{ هندسه‌های \متن‌لاتین{SharedStreet}}
  \برچسب{fig:time-conv}
\پایان{شکل}

\زیرقسمت{تجمیع سرعت رانندگان}

پس از نگاشت \متن‌لاتین{GPS} ها بر نقشه و محاسبه‌ی سرعت برای هر راننده، باید سرعت راننده‌هایی که در یک بازه‌ی زمانی نزدیک از یک خیابان رد شده اند را باهم تجمیع کنیم. در این پروژه ما بازه‌ی زمانی را برابر ۱۵ دقیقه در نظر گرفتیم. از قسمت قبل می‌توانیم چنین فایلی را تولید کنیم. قالب فایل به صورت زیر است:

خط اول مربوط به راننده‌ی اول است

راننده‌ی اول: \متن‌لاتین{SharedStreet} اول، سرعت محاسبه شده توسط این راننده در \متن‌لاتین{SharedStreet} اول، تعداد سرعت محاسبه شده توسط این راننده در \متن‌لاتین{SharedStreet} اول;  \متن‌لاتین{SharedStreet} دوم، سرعت محاسبه شده توسط این راننده در \متن‌لاتین{SharedStreet} دوم، تعداد سرعت محاسبه شده توسط این راننده در \متن‌لاتین{SharedStreet} دوم;......

خط دوم مربوط به راننده‌ی دوم است:

راننده‌ی دوم: \متن‌لاتین{SharedStreet} اول سرعت محاسبه شده توسط این راننده در \متن‌لاتین{SharedStreet} اول تعداد سرعت محاسبه شده توسط این راننده در \متن‌لاتین{SharedStreet} اول;  \متن‌لاتین{SharedStreet} دوم، سرعت محاسبه شده توسط این راننده در \متن‌لاتین{SharedStreet} دوم، تعداد سرعت محاسبه شده توسط این راننده در \متن‌لاتین{SharedStreet} دوم;......

حجم داده‌ها بسیار زیاد است، برای سرعت در تجمیع از \متن‌لاتین{pyspark} استفاده کردیم. هنگام تجمیع سرعت‌ها ابتدا سرعت‌های پرت را حذف می‌کنیم همچنین سرعت راننده‌هایی که تعداد سرعت بیشتری برای آن‌ها در خیابان حساب کردیم، وزن بیشتری در محاسبه‌ی سرعت کلی خیابان دارند. در نهایت برای هر خیابان به ازای هر ۱۵ دقیقه یک سرعت به دست می‌آوریم.

\زیرقسمت{ورودی مدل}

همانطور که بیان شد ما برای هر خیابان در هر بازه‌ی زمانی ۱۵ دقیقه به یک سرعت می‌رسیم اما در الگوریتم بیان شده ما نیاز به یک گراف داریم که سرعت ترافیک را در گره‌های این گراف پیش‌بینی می‌کنیم، همچنین ماتریس فاصله‌ی بین این گره‌ها را نیز نیاز داریم. در مجموعه داده‌ی \متن‌لاتین{PeMSD7} سرعت ترافیک توسط سنسورها اندازه‌گیری میشد که همان گره‌های گراف ما را تشکیل می‌دادند اما در این مجموعه داده با مشکل چگونگی ساخت گراف رو به رو هستیم. در این حالت وسط هر \متن‌لاتین{SharedStreet} را گره گراف در نظر گرفتیم حال به ماتریس فاصله‌ی میان گره‌ها نیاز داریم، چنین ماتریسی در دسترس نبود. برای ساخت آن مختصات جغرافیایی گره‌های گراف را به دست آورده و سپس از رابط کاربری سرویس ماتریس فاصله‌ی شرکت نشان استفاده کردیم. یک مثال از شیوه‌ی فراخوانی این رابط کاربری بدین شکل است

\begin{latin}\begin{lstlisting}
GET:
    https://api.neshan.org/v1/distance-matrix
      ?origins=36.3177579,59.5323219|36.337115,59.530621
      &destinations=36.35067,59.5451965|36.337005,59.530021
Headers:
Api-Key: YOUR_API_KEY
\end{lstlisting}\end{latin}

با قرار دادن مختصات گره‌ها در هر دو قسمت مبدا و مقصد این سرویس ماتریس فاصله را به ما بر می‌گرداند. به مختصات جغرافیایی ابتدا و انتهای هر \متن‌لاتین{SharedStreet} دسترسی داریم، از آن جایی که طول \متن‌لاتین{SharedStreet} ها کوتاه است می توان سطح کروی کره‌ی زمین را در این \متن‌لاتین{SharedStreet} ها با صفحه تقریب زد در نتیجه برای به دست آوردن مختصات جغرافیایی وسط \متن‌لاتین{Sharedstreet} میانگین مختصات ابتدا و انتهای آن را حساب کردیم.
